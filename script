<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
document.getElementById('year').textContent = new Date().getFullYear();

// Your published Google Sheet CSV link
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTyOxyhvA3RPlASauijohIlRS8O7fBqwaWw0LojpZwIMzntZEzLM_Qq2sxHJ2hA-PMyYLNzrUAQoyHT/pub?output=csv";

let products = [];
let filters = { search:"", category:"All", newOnly:false };

// Function to fetch sheet and render
function fetchProducts() {
    Papa.parse(SHEET_CSV_URL, {
        download: true,
        header: true,
        complete: function(results) {
            products = results.data.filter(p => p.Name).map(p => ({
                Name: p.Name,
                Brand: p.Brand || "",
                Category: p.Category || "Accessories",
                Price: parseFloat(p.Price) || 0,
                Image: p.Image || "",
                Specs: p.Specs || "",
                Tag: p.Tag || ""
            }));
            render();
        },
        error: function(err) {
            console.error("Error loading Google Sheet CSV", err);
        }
    });
}

// Initial fetch
fetchProducts();

// Optional: auto-refresh every 60 seconds
setInterval(fetchProducts, 60000);

// Render products
function render(){
  const grid = document.getElementById('grid');
  grid.innerHTML = "";
  let list = products.slice();

  const q = filters.search.toLowerCase();
  if(q) list = list.filter(p => p.Name.toLowerCase().includes(q) || p.Brand.toLowerCase().includes(q));
  
  if(filters.category !== "All") list = list.filter(p => p.Category === filters.category);
  if(filters.newOnly) list = list.filter(p => p.Tag.toLowerCase() === "new");

  list.forEach(p=>{
    const c = document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <img src="${p.Image}" alt="${p.Name}">
      <div class="body">
        <div style="font-weight:800">${p.Name}</div>
        <div class="brandline"><span>${p.Brand}</span><span>$${p.Price.toFixed(2)}</span></div>
        <div style="display:flex;gap:6px;margin-top:6px;">
          ${p.Tag.toLowerCase()==="new"?'<span class="tag new">NEW</span>':''}
        </div>
        <button onclick='openModal(${JSON.stringify(p)})'>View</button>
      </div>
    `;
    grid.appendChild(c);
  });
}

// Category buttons
document.querySelectorAll('.filters button[data-cat]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.filters button[data-cat]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    filters.category = btn.dataset.cat;
    filters.newOnly = false;
    document.getElementById('newBtn').classList.remove('active');
    render();
  });
});

// NEW button
document.getElementById('newBtn').addEventListener('click', ()=>{
  filters.newOnly = !filters.newOnly;
  document.getElementById('newBtn').classList.toggle('active', filters.newOnly);

  if(filters.newOnly){
    filters.category = "All";
    document.querySelectorAll('.filters button[data-cat]').forEach(b=>b.classList.remove('active'));
    document.querySelector('button[data-cat="All"]').classList.add('active');
  }
  render();
});

// Search
function applyFilters(){ filters.search = document.getElementById('search').value; render(); }

// Modal
function openModal(p){
  document.getElementById('modalBack').style.display="flex";
  document.getElementById('mtitle').textContent=p.Name;
  document.getElementById('mimg').src=p.Image;
  document.getElementById('mname').textContent=p.Name;
  document.getElementById('mbrand').textContent=p.Brand+" Â· "+p.Category;
  document.getElementById('mprice').textContent="$"+p.Price.toFixed(2);
  document.getElementById('mspecs').textContent=p.Specs;
  document.getElementById('copyBtn').onclick = ()=>{navigator.clipboard.writeText(orderText(p)).then(()=>alert("Copied!"));}
  document.getElementById('mailto').href="mailto:sales@smashhub.example?subject=Order: "+encodeURIComponent(p.Name)+"&body="+encodeURIComponent(orderText(p));
}
function closeModal(e){if(e===true||e.target.id==='modalBack'){document.getElementById('modalBack').style.display="none";}}
function orderText(p){return `I'd like to order:\n${p.Name}\nBrand: ${p.Brand}\nCategory: ${p.Category}\nPrice: $${p.Price}\nSpecs: ${p.Specs}`;}
</script>
